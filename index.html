<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="./echart.js"></script>
    <script src="./data.js"></script>
    <link rel="stylesheet" href="./index.css">
    <title>Analysis</title>
</head>
<body>
    <div id="modal" class="modal">
        <div class="logo">
            <span class="logo-span">Analysis</span>
            <br>
            <span class="logo-span" style="font-size: 16px;">Chong-Qing</span>
        </div>
    </div>
    <div>
        <h4 class="tie">
            数据来源:"中国教育在线",地点:重庆市.此处只做分析,结果仅供参考! （2018数据不全，参考价值较低）
        </h4>
    </div>
    <div class="outer">
        <div class="main" id="main">
            <div class="test">
                <input type="number" min="0" max="750" id="score" placeholder="输入分数"/>
                <select id="year">
                    <option value ="2021">2021</option>
                    <option value ="2020">2020</option>
                    <option value ="2019">2019</option>
                    <option value ="2018">2018</option>
                    <option value ="2017">2017</option>
                    <option value ="2016">2016</option>
                </select>
                <select id="subject">
                    <option value ="l">理科</option>
                    <option value ="w">文科</option>
                </select>
                <button onclick="search()">获取评估</button>
                <div id="msg"></div>
            </div>
            <div>
                <div class="chart-container" style="margin-right: 0;" id="qs"></div>
                <div class="chart-container" id="qss"></div>
            </div>
            <div class="main" id="maindiv">

            </div>
        </div>
    </div>
</body>
<script>
    var modal = document.getElementById('modal')
    // 两秒后卸载载入动画
    setTimeout(() => {
        document.body.removeChild(modal)
    }, 3000)

    var mainDiv = document.getElementById('maindiv')

    const order = ['gk2021lk', 'gk2021wk', 'gk2020lk', 'gk2020wk', 'gk2019lk', 'gk2019wk', 'gk2018lk', 'gk2018wk', 'gk2017lk', 'gk2017wk', 'gk2016lk', 'gk2016wk',]
    function initQS() {
        const yearList = [ 2021, 2019, 2018, 2017, 2016]
        const option = {
            title: {
                text: '本科线上占比走势(2018数据缺失不全)',
                left: 5
            },
            tooltip: {
                trigger: 'axis'
            },
            xAxis: {
                type: 'category',
                data: yearList
            },
            legend: {
                data: ['理科(物理)', '文科(历史)']
            },
            yAxis: {
                type: 'value'
            },
            series: [
                {
                data: [],
                type: 'line',
                smooth: true
                },
                {
                data: [],
                type: 'line',
                smooth: true
                }
            ]
        }
        yearList.map(el => {
            for (const key in data) {
                if (key.includes(el)) {
                    if(key.includes('lk')) {
                        option.series[0].data.push(data[key].proportion)
                    } else {
                        option.series[1].data.push(data[key].proportion)
                    }
                }
            }
        })
        const QS = document.getElementById('qs')
        const qse = echarts.init(QS)
        option && qse.setOption(option)
    }
    initQS()

    function initQSS() {
        const yearList = [ 2021, 2019, 2018, 2017, 2016]
        const option = {
            tooltip: {
                trigger: 'axis'
            },
            title: {
                text: '本科线上人数',
                left: 5
            },
            xAxis: {
                type: 'category',
                data: yearList
            },
            legend: {
                right: 5,
                data: ['理科(物理)', '文科(历史)']
            },
            yAxis: {
                type: 'value',
                show: false
            },
            series: [
                {
                    name: '理科(物理)',
                    data: [],
                    type: 'line',
                    smooth: true
                },
                {
                    name: '文科(历史)',
                    data: [],
                    type: 'line',
                    smooth: true
                }
            ]
        }
        yearList.map(el => {
            for (const key in data) {
                if (key.includes(el)) {
                    if(key.includes('lk')) {
                        option.series[0].data.push(data[key].theBatchTowPeopleSun)
                    } else {
                        option.series[1].data.push(data[key].theBatchTowPeopleSun)
                    }
                }
            }
        })
        const QSS = document.getElementById('qss')
        const qsse = echarts.init(QSS)
        option && qsse.setOption(option)
    }
    initQSS()
    const option = {
        title: {
            text: '',
            left: 5
        },
        // toolbox: {
        //     feature: {
        //         dataZoom: {
        //             yAxisIndex: false
        //         },
        //         saveAsImage: {
        //             pixelRatio: 2
        //         }
        //     }
        // },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            }
        },
        grid: {
            bottom: 90
        },
        dataZoom: [{
            type: 'inside'
        }, {
            type: 'slider'
        }],
        xAxis: {
            data: [],
            silent: false,
            splitLine: {
                show: false
            },
            splitArea: {
                show: false
            }
        },
        yAxis: {
            splitArea: {
                show: false
            }
        },
        series: [{
            type: 'bar',
            data: [],
            large: true,
            itemStyle: {
                color: '#0077ff'
            }
        }],
    }

    const option1 = {
        tooltip: {
            trigger: 'axis',
            formatter: '{b}分以上人数: {c}'
        },
        title: {
            left: 'left',
            text: '',
        },
        // toolbox: {
        //     feature: {
        //         dataZoom: {
        //             yAxisIndex: 'none'
        //         },
        //         restore: {},
        //         saveAsImage: {}
        //     }
        // },
        xAxis: {
            type: 'category',
            boundaryGap: false,
            data: []
        },
        yAxis: {
            show: false,
            type: 'value',
        },
        dataZoom: [{
            type: 'inside'
        }, {
            type: 'slider'
        }],
        series: [
            {
                name: '走向',
                type: 'line',
                symbol: 'none',
                sampling: 'lttb',
                itemStyle: {
                    color: 'rgb(138, 42, 226)'
                },
                areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                        offset: 0,
                        color: 'rgb(255, 192, 203)'
                    }, {
                        offset: 1,
                        color: 'rgb(138, 42, 226)'
                    }])
                },
                data: []
            }
        ]
    };
    function init() {
        var chartList = []
        var chartList1 = []
        order.map((el, index) => {
        const container = document.createElement('div')
        container.className = 'chart-container'
        const container1 = document.createElement('div')
        container1.className = 'chart-container'
        mainDiv.appendChild(container)
        mainDiv.appendChild(container1)
        const eChart = echarts.init(container)

        const option = initOption(data[el], el)
        const eChart1 = echarts.init(container1)

        const option1 = initOption1(data[el], el)

        option && eChart.setOption(option)
        option1 && eChart1.setOption(option1)
        })
    }

    function initOption(data, el) {
        const opt = JSON.parse(JSON.stringify(option))
        opt.title.text = name[el] + '成绩情况'
        opt.xAxis.data = data.list.map(el => el.score[0])
        opt.series[0].data = data.list.map(el => {
            if (data.theBatchOne && el.rank > data.theBatchOne) {
                return  {
                    value: el.num,
                    itemStyle: {
                        color: '#FFC0CB'
                    }
                }
            } else if (el.rank > data.theBatchTow) {
                return  {
                    value: el.num,
                    itemStyle: {
                        color: '#8A2BE2'
                    }
                }
            } else {
                return el.num
            }
        })
        return opt
    }
    function initOption1(data, el) {
        const opt = JSON.parse(JSON.stringify(option1))
        opt.title.text = '分数 - 人数情况'
        opt.xAxis.data = data.list.map(el => el.score[0])
        opt.series[0].data = data.list.map(el => el.total)
        return opt
    }

    init()

    function search() {
        const score = document.getElementById('score').value
        const year = Number(document.getElementById('year').value)
        const subject = document.getElementById('subject').value
        const msgdiv = document.getElementById('msg')
        msgdiv.innerHTML = ''
        console.log(score, year, subject)
        if (score > 0 && score <= 750 && year >= 2016 && year <= 2021 && subject) {
            const params = {
                score: Number(score),
                year,
                key: `gk${year}${subject === 'l' ? 'lk' : 'wk'}`,
                subject: subject === 'l' ? 'lk' : 'wk',
                subjectName: subject === 'l' ? '理科' : '文科'
            }
            const dataT = getThisYearInfo(params)
            if (dataT) {
                const pel = document.createElement('p')
                pel.innerText = `${params.year + params.subjectName}: 你的分数：${score} ,此分数段共有${dataT.num}人, 今年该科总人数${dataT.sun}人，本科分数线：${dataT.theBatchTow}，一本分数线: ${dataT.theBatchOne ? dataT.theBatchOne : '无'}. 到达本科线的比例为${dataT.proportion}。
                你的全市排名为：前${dataT.total}名，在全市比例为:${(dataT.total / dataT.sun).toFixed(4)}`
                params.selfProportion = Number((dataT.total / dataT.sun).toFixed(4))
                msgdiv.appendChild(pel)
            }
            const dataO = getOtherYearInfo(params)

            dataO.map(el => {
                msgdiv.appendChild(el.el)
            })
        }
    }

    function getThisYearInfo(params) {
        const thisYeardata = data[params.key].list.filter(el => {
            if(el.score.length === 1) {
                if (params.score === el.score[0]) {
                    return true
                } else {
                    return false
                }
            } else {
                if (params.score <= el.score[1] &&params.score >= el.score[0]) {
                    return true
                } else {
                    return false
                }
            }
        })
        if (thisYeardata.length) {
            thisYeardata[0].sun =  data[params.key].sun
            thisYeardata[0].specialBatch =  data[params.key].specialBatch
            thisYeardata[0].specialty =  data[params.key].specialty
            thisYeardata[0].theBatchTow =  data[params.key].theBatchTow
            thisYeardata[0].theBatchTowPeopleSun =  data[params.key].theBatchTowPeopleSun
            thisYeardata[0].proportion = data[params.key].proportion
            return thisYeardata[0]
        } else {
            return null
        }
    }
    function getOtherYearInfo(params) {
        const keyList = order.filter(el => {
            if (el.includes(params.subject) && !el.includes(params.year)) {
                return true
            } else {
                return false
            }
        })
        const ele = keyList.map(el => {
            const temp = data[el]
            const PP = Number(temp.sun) * params.selfProportion

            const res = getPPnum(temp, PP)

            const H = el + ''
            const header = H.replace('gk', '高考').replace('lk', '理科').replace('wk', '文科')
            const pel = document.createElement('p')
            pel.innerText = `${header} 总人数为：${temp.sun}, 本科线：${temp.theBatchTow}, 全市本科比例为：${temp.proportion}, 一本分数线：${temp.theBatchOne? temp.theBatchOne : '无'}。
            你的成绩约相当于这年的成绩${res.score}分, 排名：约前${res.total}名。`
            return {
                info: res,
                el: pel
            }
        })
        return ele
    }
    function getPPnum(temp, pp) {
        let res = {}
        const list = temp.list
        for (let i = 0; i < list.length; i++) {
            const el = list[i]
            if (pp < el.total) {
                if (i === 0) {
                    res = el
                } else {
                    res = list[i - 1]
                }
                break
            }
        }
        return res
    }
</script>
</html>