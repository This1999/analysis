<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .action{
            width: 100%;
            height: 60px;
            display: flex;
            justify-items: center;
        }
    </style>
</head>
<body>
    <div class="action">
        <div>
            <button onclick="playSong()">play</button>
            <button onclick="playWitgBiq()">playWitgBiq</button>
            <button onclick="playWithConver()">playWithConver</button>
            <button onclick="full()">full</button>
        </div>
    </div>
</body>
    <script>
        // 获取音频
        var audioSoure = document.createElement('audio')
        audioSoure.src = './demo1.mp3'
        audioSoure.controls = true
        document.body.appendChild(audioSoure)
        // 创建上下文
        var audiuoCtx = new AudioContext()
        // 创建源
        var source = audiuoCtx.createMediaElementSource(audioSoure)

        var AnalyserNode1 = audiuoCtx.createAnalyser()
        var arr1 = new Uint8Array(AnalyserNode1.frequencyBinCount)

        var AnalyserNode2 = audiuoCtx.createAnalyser()
        var arr2 = new Uint8Array(AnalyserNode2.frequencyBinCount)

        var AnalyserNode3 = audiuoCtx.createAnalyser()
        var arr3 = new Uint8Array(AnalyserNode3.frequencyBinCount)

        var destination = audiuoCtx.destination

        var grain = audiuoCtx.createGain();

        var flag = 0
        function clearnEffect() {
            if(flag === 0) {
                return 
            } else if(flag === 1) {
                source.disconnect(destination)
            } else {
                source.disconnect(grain)
            }
        }
        function playSong() {
            clearnEffect()
            flag = 1
            source.connect(AnalyserNode1)
            source.connect(destination)
        }
        function playWitgBiq() {
            clearnEffect()
            flag = 2
            source.connect(grain)
            bandBiquadFilters(audiuoCtx, source, destination)
        }
        function bandBiquadFilters(ctx, source, target) {
            const biquadFilters = []
            let out = source
            filters = []
            const arr = [60, 170, 310, 600, 1000, 3000, 6000, 12000, 14000, 16000]
            const JH = [6, 4, -5, 2, 3, 4, 4, 5, 5, 6]
            arr.forEach((el, i) => {
                const filter = ctx.createBiquadFilter()
                if (i === 0) {
                    filter.type = "lowshelf";
                } else if (i === arr.length - 1) {
                    filter.type = "highshelf";
                } else {
                    filter.type = "peaking";
                }
                filter.frequency.value = el;
                filter.gain.value = JH[i];
                filters.push(filter)
                biquadFilters.push(filter)
                if (i < 3) {
                    const gain = ctx.createGain()
                    gain.gain.value = 1.2
                    out.connect(filter)
                    filter.connect(gain)
                    out = gain
                } else {
                    out.connect(filter)
                    out = filter
                }
            })
            out.connect(AnalyserNode2)
            out.connect(target)
            //  返回过滤器
            return biquadFilters
        }

        function playWithConver() {
            convolver = audiuoCtx.createConvolver({channelCount: 2});
            var request = new XMLHttpRequest()
            request.open('GET', '/ir.wav', true)
            request.setRequestHeader("Accept", "*/*") 
            request.responseType = 'arraybuffer'
            request.onload = function () {
                var audioData = request.response
                audiuoCtx.decodeAudioData(audioData, function (buffer) {
                    clearnEffect()
                    flag = 3
                    convolver.buffer = buffer
                    source.connect(grain)
                    grain.connect(convolver)
                    convolver.connect(destination)
                    convolver.connect(AnalyserNode3)
                },
                function (e) { "Error with decoding audio data" + e.err })
            }
            request.send()
        }

        function full() {
            convolver = audiuoCtx.createConvolver({channelCount: 2});
            var request = new XMLHttpRequest()
            request.open('GET', '/ir.wav', true)
            request.setRequestHeader("Accept", "*/*") 
            request.responseType = 'arraybuffer'
            request.onload = function () {
                var audioData = request.response
                audiuoCtx.decodeAudioData(audioData, function (buffer) {
                    convolver.buffer = buffer
                    source.connect(AnalyserNode1)
                    bandBiquadFilters(audiuoCtx, source, convolver)
                    var gainNode = audiuoCtx.createGain();
                    gainNode.gain.value = 2
                    convolver.connect(gainNode)
                    gainNode.connect(AnalyserNode3)
                    gainNode.connect(destination)
                },
                function (e) { "Error with decoding audio data" + e.err })
            }
            request.send()
        }
        var width, height, ctx, wsize
        function initCanvas() {
            // height = document.body.scrollHeight
            width = document.body.scrollWidth
            height = window.innerHeight
            var canvas = document.createElement('canvas')
            canvas.width = width
            canvas.height = height
            document.body.appendChild(canvas)
            ctx = canvas.getContext('2d')
        }
        initCanvas()
        function draw() {
            ctx.moveTo(0 , height - 200)
            ctx.save()
            ctx.fillStyle = '#0000ff'
            ctx.fillRect(10, 100, 30, 30)
            ctx.fill()
            ctx.fillText('未处理', 50, 120)
            arr1.map((el, index) => {
                ctx.fillStyle = '#0000ff'
                ctx.fillRect(index * wsize, height - 400 - el, wsize, 5)
			ctx.fill()
            })
            ctx.stroke()
            ctx.restore()
            ctx.save()
            ctx.fillStyle = '#00ff00'
            ctx.fillRect(10, 150, 30, 30)
            ctx.fill()
            ctx.fillText('均衡', 50, 170)
            ctx.moveTo(0 , height - 200)
            arr2.map((el, index) => {
                ctx.fillStyle = '#00ff00'
                ctx.fillRect(index * wsize, height - 400 - el, wsize, 5)
			ctx.fill()
            })
            ctx.stroke()
            ctx.restore()
            ctx.save()
            ctx.fillStyle = '#ff0000'
            ctx.fillRect(10, 200, 30, 30)
            ctx.fill()
            ctx.fillText('混响均衡', 50, 220)
            ctx.moveTo(0 , height - 200)
            arr3.map((el, index) => {
                ctx.fillStyle = '#ff0000'
                ctx.fillRect(index * wsize, height - 400 - el, wsize, 5)
			    ctx.fill()
            })
            ctx.stroke()
            ctx.restore()
            
        }
        function render() {
            AnalyserNode1.getByteFrequencyData ? AnalyserNode1.getByteFrequencyData(arr1) : ''
            AnalyserNode2.getByteFrequencyData ? AnalyserNode2.getByteFrequencyData(arr2) : ''
            AnalyserNode3.getByteFrequencyData ? AnalyserNode3.getByteFrequencyData(arr3) : ''
            wsize = width / arr1.length
            ctx.clearRect(0, 0, width, height);
            draw()
            requestAnimationFrame(render)
        }
        render()
    </script>
</html>